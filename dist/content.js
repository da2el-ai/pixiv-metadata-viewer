(function(){"use strict";const h={IMAGE_URL_PATTERNS:[/https:\/\/i\.pximg\.net\/.*\/?img-master\/img\/(.+_p\d+)_(master|square)\d*.jpg/],ORIGINAL_URL_TEMPLATE:"https://i.pximg.net/img-original/img/$1.$2",IMAGE_FORMATS:["png"],HOVER_DELAY:500,HIDE_DELAY:200};function d(t){return t?t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""}function S(t){const e=document.querySelector(".d2-meta-badge");e&&e.setAttribute("data-active",t?"true":"false")}const M=(t,e)=>{if(!t||!t.text)return;const n=t.text,o=n.match(/Negative prompt:\s*([\s\S]*?)(?:\n[A-Z][\w ]+:\s|$)/i);o&&(e.negative=o[1].trim());const s=(n.match(/^(?:.*?(?:Steps:|Sampler:|CFG|Seed|Model|Size).*?)$/gmi)||[])[0];if(s&&s.split(",").forEach(i=>{const c=i.indexOf(":");if(c===-1)return;const r=i.slice(0,c).trim().toLowerCase(),l=i.slice(c+1).trim();r.startsWith("steps")?e.steps=l:r.startsWith("sampler")?e.sampler=l:r.startsWith("cfg")?e.cfg=l:r.startsWith("seed")?e.seed=l:r.startsWith("model")?e.model=l:r.includes("size")&&(e.size=l)}),!e.prompt&&/Negative prompt:/i.test(n)){const i=n.search(/Negative prompt:/i);e.prompt=n.slice(0,i).trim()}},N=(t,e)=>{var n,o,s,i,c,r;if(!(!t||!t.text))try{const l=t.text.trim(),m=l.startsWith('"')&&l.endsWith('"')?l.slice(1,-1):l,a=JSON.parse(m.replace(/\\"/g,'"'));(o=(n=a.v4_prompt)==null?void 0:n.caption)!=null&&o.base_caption&&(e.prompt=a.v4_prompt.caption.base_caption,(i=(s=a.v4_prompt)==null?void 0:s.caption)!=null&&i.char_captions&&(e.prompt+=`

Character Prompt:
`,a.v4_prompt.caption.char_captions.forEach(f=>{e.prompt+=`
`+f.char_caption+`
`}))),(r=(c=a.v4_negative_prompt)==null?void 0:c.caption)!=null&&r.base_caption&&(e.negative=a.v4_negative_prompt.caption.base_caption),a.sampler&&(e.sampler=a.sampler),a.steps&&(e.steps=String(a.steps)),a.scale&&(e.cfg=String(a.scale)),a.seed&&(e.seed=String(a.seed)),a.height&&a.width&&(e.size=`${a.width}x${a.height}`),e.software="NovelAI"}catch(l){console.log("NovelAI JSONパースエラー:",l)}};function C(t){const e={software:"",prompt:void 0,negative:void 0,sampler:void 0,steps:void 0,cfg:void 0,seed:void 0,model:void 0,size:void 0},n=t.find(s=>s.keyword==="parameters")||"",o=t.find(s=>s.keyword==="Comment")||"";return n?M(n,e):o&&N(o,e),e}let v=!1,w=null,u=null;function I(){const t=document.querySelector(".d2-meta-panel");if(t)return t;const e=document.createElement("div");e.className="d2-meta-panel",e.setAttribute("data-position","bottom");const n=document.createElement("div");n.classList.add("d2-meta-panel__resize","d2-meta-panel__resize--top"),n.innerHTML="⋯",n.title="ドラッグしてリサイズ",e.appendChild(n);const o=document.createElement("div");o.className="d2-meta-panel__nav-container",e.appendChild(o);const s=document.createElement("button");s.classList.add("d2-meta-panel__nav-btn","d2-meta-panel__nav-btn--position"),s.title="位置変更",s.addEventListener("click",()=>{const p=document.querySelector(".d2-meta-panel");p&&(p.getAttribute("data-position")==="top"?(p.setAttribute("data-position","bottom"),s.setAttribute("data-position","bottom")):(p.setAttribute("data-position","top"),s.setAttribute("data-position","top")))}),o.appendChild(s);const i=document.createElement("button");i.classList.add("d2-meta-panel__nav-btn","d2-meta-panel__nav-btn--close"),i.textContent="×",i.title="閉じる",i.addEventListener("click",()=>{T()}),o.appendChild(i);const c=document.createElement("div");c.className="d2-meta-panel__layout",e.appendChild(c);const r=document.createElement("div");r.className="d2-meta-panel__prompt",r.style.backgroundColor="#444",c.appendChild(r);const l=document.createElement("div");l.className="d2-meta-panel__original",l.style.backgroundColor="#444",c.appendChild(l);const m=document.createElement("div");m.classList.add("d2-meta-panel__resize","d2-meta-panel__resize--bottom"),m.innerHTML="⋯",m.title="ドラッグしてリサイズ",e.appendChild(m);let a=0,f=0;n.addEventListener("mousedown",p=>{p.preventDefault(),a=p.clientY,f=parseInt(getComputedStyle(e).height,10),document.addEventListener("mousemove",P),document.addEventListener("mouseup",L)}),m.addEventListener("mousedown",p=>{p.preventDefault(),a=p.clientY,f=parseInt(getComputedStyle(e).height,10),document.addEventListener("mousemove",b),document.addEventListener("mouseup",L)});function P(p){const g=f-(p.clientY-a);g>100&&(e.style.height=`${g}px`)}function b(p){const g=f+(p.clientY-a);g>100&&(e.style.height=`${g}px`)}function L(){document.removeEventListener("mousemove",P),document.removeEventListener("mousemove",b),document.removeEventListener("mouseup",L)}return document.body.appendChild(e),e}function $(t,e){const n=t.querySelector(".d2-meta-panel__prompt"),o=t.querySelector(".d2-meta-panel__original");if(!n||!o)return;const s=e.parsed&&e.parsed.items&&e.parsed.items.length>0;if(t.style.opacity=s?"1":"0.5",e.isNotPng){n.innerHTML="<p>PNG以外の画像形式のため、メタデータは表示されません。</p>",o.innerHTML="";return}const i=e.parsed&&e.parsed.items?C(e.parsed.items):{};let c="";i.prompt&&(c+=`<h3>Prompt</h3><p style="white-space: pre-wrap;">${d(i.prompt)}</p>`),i.negative&&(c+=`<h3>Negative Prompt</h3><p style="white-space: pre-wrap;">${d(i.negative)}</p>`);let r="<h3>Parameters</h3><ul>";if(i.sampler&&(r+=`<li>Sampler: ${d(i.sampler)}</li>`),i.steps&&(r+=`<li>Steps: ${d(i.steps)}</li>`),i.cfg&&(r+=`<li>CFG: ${d(i.cfg)}</li>`),i.seed&&(r+=`<li>Seed: ${d(i.seed)}</li>`),i.model&&(r+=`<li>Model: ${d(i.model)}</li>`),i.size&&(r+=`<li>Size: ${d(i.size)}</li>`),i.software&&(r+=`<li>Software: ${d(i.software)}</li>`),r+="</ul>",n.innerHTML=c||"<p>プロンプト情報が見つかりませんでした。</p>",o.innerHTML=r,e.parsed&&e.parsed.items&&e.parsed.items.length>0){let l="<h3>Original Data</h3><ul>";e.parsed.items.forEach(m=>{l+=`<li><strong>${d(m.keyword)}</strong>: <span style="white-space: pre-wrap;">${d(m.text)}</span></li>`}),l+="</ul>",o.innerHTML+=l}}function _(t,e=!1){if(v&&!e)return;const n=I();u&&(clearTimeout(u),u=null),$(n,t),n.setAttribute("data-is-show","true"),v=e,w=t,S(e)}function H(){v||(u&&clearTimeout(u),u=window.setTimeout(()=>{const t=document.querySelector(".d2-meta-panel");t&&t.setAttribute("data-is-show","false"),u=null},h.HIDE_DELAY))}function T(){v=!1,H(),S(!1)}function x(){return v}function z(){return w}let E=null,A=!1;console.log("/////////////////// PIXIV-METADATA-VIEWER");function y(t){return h.IMAGE_URL_PATTERNS.some(e=>e.test(t))}function R(t){for(const e of h.IMAGE_URL_PATTERNS){const n=t.match(e);if(n&&n[1])return`https://i.pximg.net/img-original/img/${n[1]}`}return null}async function G(t){if(!t||t.length===0)throw new Error("画像URLが指定されていません");return new Promise((e,n)=>{chrome.runtime.sendMessage({type:"GET_METADATA",imageUrls:t},o=>{if(chrome.runtime.lastError){n(chrome.runtime.lastError);return}o.success?e(o.metadata):n(new Error(o.error||"メタデータの取得に失敗しました"))})})}async function O(t){if(!A)try{const e=t.src,n=R(e),o=[];n&&h.IMAGE_FORMATS.forEach(s=>{o.push(`${n}.${s}`)});try{const s=await G(o);_(s)}catch(s){const i={isNotPng:!1,parsed:{items:[]}};s instanceof Error&&s.message&&s.message.includes("HTTP 404")&&(i.isNotPng=!0),_(i)}}catch{_({isNotPng:!0,parsed:{items:[]}})}}function D(){document.addEventListener("mouseover",t=>{const e=t.target;if(e.tagName==="IMG"){const n=e,o=n.src;y(o)&&(E&&clearTimeout(E),E=window.setTimeout(()=>{O(n)},h.HOVER_DELAY))}})}D(),chrome.runtime.onMessage.addListener(t=>{if(t&&t.type==="TOGGLE_PANEL"){const e=document.querySelector(".d2-meta-panel");if(e)if(e.getAttribute("data-is-show")==="true")e.setAttribute("data-is-show","false"),x()&&T(),A=!0;else{const o=z()||{isNotPng:!1,parsed:{items:[]}};_(o,!1),A=!1}}})})();
//# sourceMappingURL=content.js.map
