(function(){"use strict";const f={IMAGE_URL_PATTERNS:[/https:\/\/i\.pximg\.net\/.*\/?img-master\/img\/(.+_p\d+)_(master|square)\d*.jpg/],ORIGINAL_URL_TEMPLATE:"https://i.pximg.net/img-original/img/$1.$2",IMAGE_FORMATS:["png"],HOVER_DELAY:500,HIDE_DELAY:200};function p(t){return t?t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""}function v(t){const e=document.querySelector(".d2-meta-badge");e&&e.setAttribute("data-active",t?"true":"false")}const E=(t,e)=>{if(!t||!t.text)return;const n=t.text;console.log("[extractPromptA1111]",n);const o=n.match(/Negative prompt:\s*([\s\S]*?)(?:\n[A-Z][\w ]+:\s|$)/i);o&&(e.negative=o[1].trim());const i=(n.match(/^(?:.*?(?:Steps:|Sampler:|CFG|Seed|Model|Size).*?)$/gmi)||[])[0];if(i&&i.split(",").forEach(l=>{const s=l.indexOf(":");if(s===-1)return;const c=l.slice(0,s).trim().toLowerCase(),a=l.slice(s+1).trim();c.startsWith("steps")?e.steps=a:c.startsWith("sampler")?e.sampler=a:c.startsWith("cfg")?e.cfg=a:c.startsWith("seed")?e.seed=a:c.startsWith("model")?e.model=a:c.includes("size")&&(e.size=a)}),!e.prompt&&/Negative prompt:/i.test(n)){const l=n.search(/Negative prompt:/i);e.prompt=n.slice(0,l).trim()}},S=(t,e)=>{var n,o,i,l,s,c;if(!(!t||!t.text))try{const a=t.text.trim(),u=a.startsWith('"')&&a.endsWith('"')?a.slice(1,-1):a,r=JSON.parse(u.replace(/\\"/g,'"'));(o=(n=r.v4_prompt)==null?void 0:n.caption)!=null&&o.base_caption&&(e.prompt=r.v4_prompt.caption.base_caption,(l=(i=r.v4_prompt)==null?void 0:i.caption)!=null&&l.char_captions&&(e.prompt+=`

Character Prompt:
`,r.v4_prompt.caption.char_captions.forEach(m=>{e.prompt+=`
`+m.char_caption+`
`}))),(c=(s=r.v4_negative_prompt)==null?void 0:s.caption)!=null&&c.base_caption&&(e.negative=r.v4_negative_prompt.caption.base_caption),r.sampler&&(e.sampler=r.sampler),r.steps&&(e.steps=String(r.steps)),r.scale&&(e.cfg=String(r.scale)),r.seed&&(e.seed=String(r.seed)),r.height&&r.width&&(e.size=`${r.width}x${r.height}`),e.software="NovelAI"}catch(a){console.log("NovelAI JSONパースエラー:",a)}};function w(t){const e={software:"",prompt:void 0,negative:void 0,sampler:void 0,steps:void 0,cfg:void 0,seed:void 0,model:void 0,size:void 0},n=t.find(i=>i.keyword==="parameters")||"",o=t.find(i=>i.keyword==="Comment")||"";return n?E(n,e):o&&S(o,e),e}let g=!1,d=null;function A(){const t=document.querySelector(".d2-meta-panel");if(t)return t;const e=document.createElement("div");e.className="d2-meta-panel";const n=document.createElement("div");n.className="d2-meta-panel__resize",n.innerHTML="⋯",n.title="ドラッグしてリサイズ",e.appendChild(n);const o=document.createElement("div");o.className="d2-meta-panel__close",o.textContent="×",o.title="閉じる",o.addEventListener("click",()=>{P()}),e.appendChild(o);const i=document.createElement("div");i.className="d2-meta-panel__layout",e.appendChild(i);const l=document.createElement("div");l.className="d2-meta-panel__prompt",l.style.backgroundColor="#444",i.appendChild(l);const s=document.createElement("div");s.className="d2-meta-panel__original",s.style.backgroundColor="#444",i.appendChild(s);let c=0,a=0;n.addEventListener("mousedown",m=>{m.preventDefault(),c=m.clientY,a=parseInt(getComputedStyle(e).height,10),document.addEventListener("mousemove",u),document.addEventListener("mouseup",r)});function u(m){const _=a-(m.clientY-c);_>100&&(e.style.height=`${_}px`)}function r(){document.removeEventListener("mousemove",u),document.removeEventListener("mouseup",r)}return document.body.appendChild(e),e}function T(t,e){const n=t.querySelector(".d2-meta-panel__prompt"),o=t.querySelector(".d2-meta-panel__original");if(!n||!o)return;if(e.isNotPng){n.innerHTML="<p>PNG以外の画像形式のため、メタデータは表示されません。</p>",o.innerHTML="";return}console.log("メタデータ",e.parsed.items);const i=e.parsed&&e.parsed.items?w(e.parsed.items):{};let l="";i.prompt&&(l+=`<h3>Prompt</h3><p style="white-space: pre-wrap;">${p(i.prompt)}</p>`),i.negative&&(l+=`<h3>Negative Prompt</h3><p style="white-space: pre-wrap;">${p(i.negative)}</p>`);let s="<h3>Parameters</h3><ul>";if(i.sampler&&(s+=`<li>Sampler: ${p(i.sampler)}</li>`),i.steps&&(s+=`<li>Steps: ${p(i.steps)}</li>`),i.cfg&&(s+=`<li>CFG: ${p(i.cfg)}</li>`),i.seed&&(s+=`<li>Seed: ${p(i.seed)}</li>`),i.model&&(s+=`<li>Model: ${p(i.model)}</li>`),i.size&&(s+=`<li>Size: ${p(i.size)}</li>`),i.software&&(s+=`<li>Software: ${p(i.software)}</li>`),s+="</ul>",n.innerHTML=l||"<p>プロンプト情報が見つかりませんでした。</p>",o.innerHTML=s,e.parsed&&e.parsed.items&&e.parsed.items.length>0){let c="<h3>Original Data</h3><ul>";e.parsed.items.forEach(a=>{c+=`<li><strong>${p(a.keyword)}</strong>: <span style="white-space: pre-wrap;">${p(a.text)}</span></li>`}),c+="</ul>",o.innerHTML+=c}}function L(t,e=!1){if(g&&!e)return;const n=A();d&&(clearTimeout(d),d=null),T(n,t),n.setAttribute("data-is-show","true"),g=e,v(e)}function M(){g||(d&&clearTimeout(d),d=window.setTimeout(()=>{const t=document.querySelector(".d2-meta-panel");t&&t.setAttribute("data-is-show","false"),d=null},f.HIDE_DELAY))}function P(){g=!1,M(),v(!1)}let h=null;console.log("/////////////////// PIXIV-METADATA-VIEWER");function N(t){return f.IMAGE_URL_PATTERNS.some(e=>e.test(t))}function I(t){for(const e of f.IMAGE_URL_PATTERNS){const n=t.match(e);if(n&&n[1])return`https://i.pximg.net/img-original/img/${n[1]}`}return null}async function $(t){if(!t||t.length===0)throw new Error("画像URLが指定されていません");return console.log("fetchMetadata",t),new Promise((e,n)=>{chrome.runtime.sendMessage({type:"GET_METADATA",imageUrls:t},o=>{if(chrome.runtime.lastError){n(chrome.runtime.lastError);return}o.success?e(o.metadata):n(new Error(o.error||"メタデータの取得に失敗しました"))})})}async function x(t){try{const e=t.src,n=I(e),o=[];console.log("元の画像URL:",e),n&&f.IMAGE_FORMATS.forEach(i=>{o.push(`${n}.${i}`)});try{const i=await $(o);L(i)}catch(i){console.log("メタデータ取得エラー:",i)}}catch(e){console.log("画像処理エラー:",e)}}function C(){console.log("[PMV] initialize"),document.addEventListener("mouseover",t=>{const e=t.target;if(e.tagName==="IMG"){const n=e,o=n.src;console.log("[PMV] initialize src",o),N(o)&&(console.log("[PMV] initialize isTarget"),h&&clearTimeout(h),h=window.setTimeout(()=>{x(n)},f.HOVER_DELAY))}})}C()})();
//# sourceMappingURL=content.js.map
