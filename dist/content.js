(function(){"use strict";const g={IMAGE_URL_PATTERNS:[/https:\/\/i\.pximg\.net\/.*\/?img-master\/img\/(.+_p\d+)_(master|square)\d*.jpg/],ORIGINAL_URL_TEMPLATE:"https://i.pximg.net/img-original/img/$1.$2",IMAGE_FORMATS:["png"],HOVER_DELAY:500,HIDE_DELAY:200};function p(t){return t?t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""}function E(t){const e=document.querySelector(".d2-meta-badge");e&&e.setAttribute("data-active",t?"true":"false")}const S=(t,e)=>{if(!t||!t.text)return;const i=t.text;console.log("[extractPromptA1111]",i);const r=i.match(/Negative prompt:\s*([\s\S]*?)(?:\n[A-Z][\w ]+:\s|$)/i);r&&(e.negative=r[1].trim());const s=(i.match(/^(?:.*?(?:Steps:|Sampler:|CFG|Seed|Model|Size).*?)$/gmi)||[])[0];if(s&&s.split(",").forEach(n=>{const l=n.indexOf(":");if(l===-1)return;const o=n.slice(0,l).trim().toLowerCase(),c=n.slice(l+1).trim();o.startsWith("steps")?e.steps=c:o.startsWith("sampler")?e.sampler=c:o.startsWith("cfg")?e.cfg=c:o.startsWith("seed")?e.seed=c:o.startsWith("model")?e.model=c:o.includes("size")&&(e.size=c)}),!e.prompt&&/Negative prompt:/i.test(i)){const n=i.search(/Negative prompt:/i);e.prompt=i.slice(0,n).trim()}},w=(t,e)=>{var i,r,s,n,l,o;if(!(!t||!t.text))try{const c=t.text.trim(),m=c.startsWith('"')&&c.endsWith('"')?c.slice(1,-1):c,a=JSON.parse(m.replace(/\\"/g,'"'));(r=(i=a.v4_prompt)==null?void 0:i.caption)!=null&&r.base_caption&&(e.prompt=a.v4_prompt.caption.base_caption,(n=(s=a.v4_prompt)==null?void 0:s.caption)!=null&&n.char_captions&&(e.prompt+=`

Character Prompt:
`,a.v4_prompt.caption.char_captions.forEach(f=>{e.prompt+=`
`+f.char_caption+`
`}))),(o=(l=a.v4_negative_prompt)==null?void 0:l.caption)!=null&&o.base_caption&&(e.negative=a.v4_negative_prompt.caption.base_caption),a.sampler&&(e.sampler=a.sampler),a.steps&&(e.steps=String(a.steps)),a.scale&&(e.cfg=String(a.scale)),a.seed&&(e.seed=String(a.seed)),a.height&&a.width&&(e.size=`${a.width}x${a.height}`),e.software="NovelAI"}catch(c){console.log("NovelAI JSONパースエラー:",c)}};function T(t){const e={software:"",prompt:void 0,negative:void 0,sampler:void 0,steps:void 0,cfg:void 0,seed:void 0,model:void 0,size:void 0},i=t.find(s=>s.keyword==="parameters")||"",r=t.find(s=>s.keyword==="Comment")||"";return i?S(i,e):r&&w(r,e),e}let u=!1,d=null;function A(){const t=document.querySelector(".d2-meta-panel");if(t)return t;const e=document.createElement("div");e.className="d2-meta-panel";const i=document.createElement("div");i.className="d2-meta-panel__resize",i.innerHTML="⋯",i.title="ドラッグしてリサイズ",e.appendChild(i);const r=document.createElement("div");r.className="d2-meta-panel__close",r.textContent="×",r.title="閉じる",r.addEventListener("click",()=>{M()}),e.appendChild(r);const s=document.createElement("div");s.className="d2-meta-panel__layout",e.appendChild(s);const n=document.createElement("div");n.className="d2-meta-panel__prompt",n.style.backgroundColor="#444",s.appendChild(n);const l=document.createElement("div");l.className="d2-meta-panel__original",l.style.backgroundColor="#444",s.appendChild(l);let o=0,c=0;i.addEventListener("mousedown",f=>{f.preventDefault(),o=f.clientY,c=parseInt(getComputedStyle(e).height,10),document.addEventListener("mousemove",m),document.addEventListener("mouseup",a)});function m(f){const _=c-(f.clientY-o);_>100&&(e.style.height=`${_}px`)}function a(){document.removeEventListener("mousemove",m),document.removeEventListener("mouseup",a)}return document.body.appendChild(e),e}function P(t,e){const i=t.querySelector(".d2-meta-panel__prompt"),r=t.querySelector(".d2-meta-panel__original");if(!i||!r)return;const s=e.parsed&&e.parsed.items&&e.parsed.items.length>0;if(t.style.opacity=s?"1":"0.5",e.isNotPng){i.innerHTML="<p>PNG以外の画像形式のため、メタデータは表示されません。</p>",r.innerHTML="";return}const n=e.parsed&&e.parsed.items?T(e.parsed.items):{};let l="";n.prompt&&(l+=`<h3>Prompt</h3><p style="white-space: pre-wrap;">${p(n.prompt)}</p>`),n.negative&&(l+=`<h3>Negative Prompt</h3><p style="white-space: pre-wrap;">${p(n.negative)}</p>`);let o="<h3>Parameters</h3><ul>";if(n.sampler&&(o+=`<li>Sampler: ${p(n.sampler)}</li>`),n.steps&&(o+=`<li>Steps: ${p(n.steps)}</li>`),n.cfg&&(o+=`<li>CFG: ${p(n.cfg)}</li>`),n.seed&&(o+=`<li>Seed: ${p(n.seed)}</li>`),n.model&&(o+=`<li>Model: ${p(n.model)}</li>`),n.size&&(o+=`<li>Size: ${p(n.size)}</li>`),n.software&&(o+=`<li>Software: ${p(n.software)}</li>`),o+="</ul>",i.innerHTML=l||"<p>プロンプト情報が見つかりませんでした。</p>",r.innerHTML=o,e.parsed&&e.parsed.items&&e.parsed.items.length>0){let c="<h3>Original Data</h3><ul>";e.parsed.items.forEach(m=>{c+=`<li><strong>${p(m.keyword)}</strong>: <span style="white-space: pre-wrap;">${p(m.text)}</span></li>`}),c+="</ul>",r.innerHTML+=c}}function h(t,e=!1){if(u&&!e)return;const i=A();d&&(clearTimeout(d),d=null),P(i,t),i.setAttribute("data-is-show","true"),u=e,E(e)}function L(){u||(d&&clearTimeout(d),d=window.setTimeout(()=>{const t=document.querySelector(".d2-meta-panel");t&&t.setAttribute("data-is-show","false"),d=null},g.HIDE_DELAY))}function M(){u=!1,L(),E(!1)}let v=null;console.log("/////////////////// PIXIV-METADATA-VIEWER");function N(t){return g.IMAGE_URL_PATTERNS.some(e=>e.test(t))}function I(t){for(const e of g.IMAGE_URL_PATTERNS){const i=t.match(e);if(i&&i[1])return`https://i.pximg.net/img-original/img/${i[1]}`}return null}async function $(t){if(!t||t.length===0)throw new Error("画像URLが指定されていません");return new Promise((e,i)=>{chrome.runtime.sendMessage({type:"GET_METADATA",imageUrls:t},r=>{if(chrome.runtime.lastError){i(chrome.runtime.lastError);return}r.success?e(r.metadata):i(new Error(r.error||"メタデータの取得に失敗しました"))})})}async function x(t){try{const e=t.src,i=I(e),r=[];i&&g.IMAGE_FORMATS.forEach(s=>{r.push(`${i}.${s}`)});try{const s=await $(r);h(s)}catch(s){const n={isNotPng:!1,parsed:{items:[]}};s instanceof Error&&s.message&&s.message.includes("HTTP 404")&&(n.isNotPng=!0),h(n)}}catch{h({isNotPng:!0,parsed:{items:[]}})}}function H(){document.addEventListener("mouseover",t=>{const e=t.target;if(e.tagName==="IMG"){const i=e,r=i.src;N(r)&&(v&&clearTimeout(v),v=window.setTimeout(()=>{x(i)},g.HOVER_DELAY))}})}H()})();
//# sourceMappingURL=content.js.map
