(function(){"use strict";const f={IMAGE_URL_PATTERNS:[/https:\/\/i\.pximg\.net\/.*\/?img-master\/img\/(.+_p\d+)_(master|square)\d*.jpg/],ORIGINAL_URL_TEMPLATE:"https://i.pximg.net/img-original/img/$1.$2",IMAGE_FORMATS:["png"],HOVER_DELAY:300,HIDE_DELAY:200};function E(t){const e=t.parentElement;if(e&&e.querySelectorAll(".d2-meta-badge").length)return;const n=document.createElement("div");if(n.className="d2-meta-badge",n.textContent="META",t.getBoundingClientRect(),e){const s=window.getComputedStyle(e);["relative","absolute","fixed"].includes(s.position)||(e.style.position="relative"),e.appendChild(n)}}function d(t){return t?t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""}const $=(t,e)=>{if(!t||!t.text)return;const n=t.text,s=n.match(/Negative prompt:\s*([\s\S]*?)(?:\n[A-Z][\w ]+:\s|$)/i);s&&(e.negative=s[1].trim());const o=(n.match(/^(?:.*?(?:Steps:|Sampler:|CFG|Seed|Model|Size).*?)$/gmi)||[])[0];if(o&&o.split(",").forEach(i=>{const l=i.indexOf(":");if(l===-1)return;const a=i.slice(0,l).trim().toLowerCase(),c=i.slice(l+1).trim();a.startsWith("steps")?e.steps=c:a.startsWith("sampler")?e.sampler=c:a.startsWith("cfg")?e.cfg=c:a.startsWith("seed")?e.seed=c:a.startsWith("model")?e.model=c:a.includes("size")&&(e.size=c)}),!e.prompt&&/Negative prompt:/i.test(n)){const i=n.search(/Negative prompt:/i);e.prompt=n.slice(0,i).trim()}},x=(t,e)=>{var n,s,o,i,l,a;if(!(!t||!t.text))try{const c=t.text.trim(),m=c.startsWith('"')&&c.endsWith('"')?c.slice(1,-1):c,r=JSON.parse(m.replace(/\\"/g,'"'));(s=(n=r.v4_prompt)==null?void 0:n.caption)!=null&&s.base_caption&&(e.prompt=r.v4_prompt.caption.base_caption,(i=(o=r.v4_prompt)==null?void 0:o.caption)!=null&&i.char_captions&&(e.prompt+=`

Character Prompt:
`,r.v4_prompt.caption.char_captions.forEach(v=>{e.prompt+=`
`+v.char_caption+`
`}))),(a=(l=r.v4_negative_prompt)==null?void 0:l.caption)!=null&&a.base_caption&&(e.negative=r.v4_negative_prompt.caption.base_caption),r.sampler&&(e.sampler=r.sampler),r.steps&&(e.steps=String(r.steps)),r.scale&&(e.cfg=String(r.scale)),r.seed&&(e.seed=String(r.seed)),r.height&&r.width&&(e.size=`${r.width}x${r.height}`),e.software="NovelAI"}catch(c){console.log("NovelAI JSONパースエラー:",c)}};function H(t){const e={software:"",prompt:void 0,negative:void 0,sampler:void 0,steps:void 0,cfg:void 0,seed:void 0,model:void 0,size:void 0},n=t.find(o=>o.keyword==="parameters")||"",s=t.find(o=>o.keyword==="Comment")||"";return n?$(n,e):s&&x(s,e),e}let T=null,g=null;function z(){const t=document.querySelector(".d2-meta-panel");if(t)return t;const e=document.createElement("div");e.className="d2-meta-panel",e.setAttribute("data-position","bottom");const n=document.createElement("div");n.classList.add("d2-meta-panel__resize","d2-meta-panel__resize--top"),n.innerHTML="⋯",n.title="ドラッグしてリサイズ",e.appendChild(n);const s=document.createElement("div");s.className="d2-meta-panel__nav-container",e.appendChild(s);const o=document.createElement("button");o.classList.add("d2-meta-panel__nav-btn","d2-meta-panel__nav-btn--position"),o.title="位置変更",o.addEventListener("click",()=>{const p=document.querySelector(".d2-meta-panel");p&&(p.getAttribute("data-position")==="top"?(p.setAttribute("data-position","bottom"),o.setAttribute("data-position","bottom")):(p.setAttribute("data-position","top"),o.setAttribute("data-position","top")))}),s.appendChild(o);const i=document.createElement("button");i.classList.add("d2-meta-panel__nav-btn","d2-meta-panel__nav-btn--close"),i.textContent="×",i.title="閉じる",i.addEventListener("click",()=>{L()}),s.appendChild(i);const l=document.createElement("div");l.className="d2-meta-panel__layout",e.appendChild(l);const a=document.createElement("div");a.className="d2-meta-panel__prompt",a.style.backgroundColor="#444",l.appendChild(a);const c=document.createElement("div");c.className="d2-meta-panel__original",c.style.backgroundColor="#444",l.appendChild(c);const m=document.createElement("div");m.classList.add("d2-meta-panel__resize","d2-meta-panel__resize--bottom"),m.innerHTML="⋯",m.title="ドラッグしてリサイズ",e.appendChild(m);let r=0,v=0;n.addEventListener("mousedown",p=>{p.preventDefault(),r=p.clientY,v=parseInt(getComputedStyle(e).height,10),document.addEventListener("mousemove",y),document.addEventListener("mouseup",S)}),m.addEventListener("mousedown",p=>{p.preventDefault(),r=p.clientY,v=parseInt(getComputedStyle(e).height,10),document.addEventListener("mousemove",C),document.addEventListener("mouseup",S)});function y(p){const _=v-(p.clientY-r);_>100&&(e.style.height=`${_}px`)}function C(p){const _=v+(p.clientY-r);_>100&&(e.style.height=`${_}px`)}function S(){document.removeEventListener("mousemove",y),document.removeEventListener("mousemove",C),document.removeEventListener("mouseup",S)}return document.body.appendChild(e),e}function O(t,e){const n=t.querySelector(".d2-meta-panel__prompt"),s=t.querySelector(".d2-meta-panel__original");if(!n||!s)return;const o=e.parsed&&e.parsed.items&&e.parsed.items.length>0;if(t.style.opacity=o?"1":"0.5",e.isNotPng){n.innerHTML="<p>PNG以外の画像形式のため、メタデータは表示されません。</p>",s.innerHTML="";return}const i=e.parsed&&e.parsed.items?H(e.parsed.items):{};let l="";i.prompt&&(l+=`<h3>Prompt</h3><p style="white-space: pre-wrap;">${d(i.prompt)}</p>`),i.negative&&(l+=`<h3>Negative Prompt</h3><p style="white-space: pre-wrap;">${d(i.negative)}</p>`);let a="<h3>Parameters</h3><ul>";if(i.sampler&&(a+=`<li>Sampler: ${d(i.sampler)}</li>`),i.steps&&(a+=`<li>Steps: ${d(i.steps)}</li>`),i.cfg&&(a+=`<li>CFG: ${d(i.cfg)}</li>`),i.seed&&(a+=`<li>Seed: ${d(i.seed)}</li>`),i.model&&(a+=`<li>Model: ${d(i.model)}</li>`),i.size&&(a+=`<li>Size: ${d(i.size)}</li>`),i.software&&(a+=`<li>Software: ${d(i.software)}</li>`),a+="</ul>",n.innerHTML=l||"<p>プロンプト情報が見つかりませんでした。</p>",s.innerHTML=a,e.parsed&&e.parsed.items&&e.parsed.items.length>0){let c="<h3>Original Data</h3><ul>";e.parsed.items.forEach(m=>{c+=`<li><strong>${d(m.keyword)}</strong>: <span style="white-space: pre-wrap;">${d(m.text)}</span></li>`}),c+="</ul>",s.innerHTML+=c}}function h(t){const e=z();g&&(clearTimeout(g),g=null),O(e,t),e.setAttribute("data-is-show","true"),T=t}function L(){g&&clearTimeout(g),g=window.setTimeout(()=>{const t=document.querySelector(".d2-meta-panel");t&&t.setAttribute("data-is-show","false"),g=null},f.HIDE_DELAY)}function R(){return T}let b=null,M=!1;const u=new Map;console.log("/////////////////// PIXIV-METADATA-VIEWER");function I(t){return f.IMAGE_URL_PATTERNS.some(e=>e.test(t))}function P(t){for(const e of f.IMAGE_URL_PATTERNS){const n=t.match(e);if(n&&n[1])return`https://i.pximg.net/img-original/img/${n[1]}`}return null}async function w(t){if(!t||t.length===0)throw new Error("画像URLが指定されていません");return new Promise((e,n)=>{chrome.runtime.sendMessage({type:"GET_METADATA",imageUrls:t},s=>{if(chrome.runtime.lastError){n(chrome.runtime.lastError);return}s.success?e(s.metadata):n(new Error(s.error||"メタデータの取得に失敗しました"))})})}async function G(t){if(!M)try{const e=t.src;if(u.has(e)){const o=u.get(e);o.hasMetadata&&E(t);const i=o.baseUrl,l=[];if(i){f.IMAGE_FORMATS.forEach(a=>{l.push(`${i}.${a}`)});try{const a=await w(l);h(a)}catch{h({isNotPng:!1,parsed:{items:[]}})}}return}const n=P(e),s=[];n&&f.IMAGE_FORMATS.forEach(o=>{s.push(`${n}.${o}`)});try{const o=await w(s);h(o);const i=o.parsed.items.length>=2||o.parsed.items.length>0&&o.parsed.items[0].keyword==="parameters";u.set(e,{url:e,hasMetadata:i,baseUrl:n}),i&&E(t)}catch(o){const i={isNotPng:!1,parsed:{items:[]}};o instanceof Error&&o.message&&o.message.includes("HTTP 404")&&(i.isNotPng=!0),h(i),u.set(e,{url:e,hasMetadata:!1,baseUrl:n})}}catch(e){console.log("[PMV] 画像処理エラー:",e),h({isNotPng:!0,parsed:{items:[]}})}}async function U(t){if(M)return;const e=t.src;if(u.has(e)){u.get(e).hasMetadata&&E(t);return}const n=P(e),s=[];n&&f.IMAGE_FORMATS.forEach(o=>{s.push(`${n}.${o}`)});try{const o=await w(s),i=o.parsed.items.length>=2||o.parsed.items.length>0&&o.parsed.items[0].keyword==="parameters";u.set(e,{url:e,hasMetadata:i,baseUrl:n}),i&&E(t)}catch{u.set(e,{url:e,hasMetadata:!1,baseUrl:n})}}function N(){document.querySelectorAll(".__top_side_menu_body img").forEach(e=>{const n=e.src;I(n)&&U(e)})}let A=null;function k(){const t=s=>{A&&clearTimeout(A),A=window.setTimeout(()=>{N()},1e3)},e=new MutationObserver(t),n={childList:!0,subtree:!0};e.observe(document.body,n)}function D(){console.log("[PMV] initialize"),setTimeout(()=>{N(),k()},1e3),document.addEventListener("mouseover",t=>{const e=t.target;if(e.tagName==="IMG"){const n=e,s=n.src;I(s)&&(b&&clearTimeout(b),b=window.setTimeout(()=>{G(n)},f.HOVER_DELAY))}})}D(),chrome.runtime.onMessage.addListener(t=>{if(t&&t.type==="TOGGLE_PANEL"){const e=document.querySelector(".d2-meta-panel");if(e)if(e.getAttribute("data-is-show")==="true")e.setAttribute("data-is-show","false"),L(),M=!0;else{const s=R()||{isNotPng:!1,parsed:{items:[]}};h(s),M=!1}}t&&t.type==="DEBUG_INFO"&&(console.log("[PMV Debug]",t.label||"デバッグ情報:"),t.data&&console.log(t.data),t.error&&console.error("[PMV Error]",t.error))})})();
//# sourceMappingURL=content.js.map
